options:
  logging: CLOUD_LOGGING_ONLY

steps:
  # === PRE-CHECKS ===
  - id: 'guard-region'
    name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - -lc
      - |
        set -euo pipefail
        REGION="${_REGION}"
        if [[ -z "${REGION}" || "${REGION}" == "unset" ]]; then
          echo "ERROR: _REGION must be set in the Cloud Build trigger (e.g., asia-northeast1)." 1>&2
          exit 1
        fi
  - name: gcr.io/cloud-builders/docker
    args: ['build','-t','gcr.io/$PROJECT_ID/picca-api-go:$SHORT_SHA','.']
    dir: 'services/api-go'

  - name: gcr.io/cloud-builders/docker
    args: ['push','gcr.io/$PROJECT_ID/picca-api-go:$SHORT_SHA']

  - name: gcr.io/cloud-builders/gcloud
    args: [
      'run','deploy','picca-api-go-stg',
      '--image','gcr.io/$PROJECT_ID/picca-api-go:$SHORT_SHA',
      '--region','${_REGION}',
      '--platform','managed',
      '--allow-unauthenticated'
  ]

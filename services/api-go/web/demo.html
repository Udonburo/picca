<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>picca demo</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    textarea { width:100%; height:180px; font-family: ui-monospace, monospace; }
    button { padding:8px 12px; border:1px solid #ddd; background:#fafafa; cursor:pointer; border-radius:8px; }
    .card { border:1px solid #eee; border-radius:12px; padding:16px; margin-top:16px; }
    .kpi { display:flex; gap:16px; }
    .kpi > div { padding:12px; border-radius:10px; border:1px solid #eee; min-width:120px; }
    .ok { color:#0a0; } .warn { color:#a60; } .err { color:#d00; }
    .muted { color:#666; font-size:12px; }
    input[type="text"] { padding:8px; border:1px solid #ddd; border-radius:8px; min-width:300px; }
  </style>
</head>
<body>
  <h1>picca demo</h1>
  <p class="muted">Same-origin demo page served by the API service. Provide an API key, craft payload, and run.</p>

  <div class="row">
    <label>API Key:
      <input id="apiKey" type="text" placeholder="X-API-Key" />
    </label>
    <button id="saveKey">Save to localStorage</button>
    <button id="gen">Generate dummy (100 pts)</button>
    <button id="score">Score</button>
    <button id="explain" disabled>Explain (beta)</button>
  </div>

  <div class="card">
    <div class="muted">Payload (JSON)</div>
    <textarea id="payload"></textarea>
  </div>

  <div class="card" id="result" style="display:none;">
    <div class="muted" id="meta"></div>
    <div class="kpi">
      <div><div>Score</div><div id="scoreVal">-</div></div>
      <div><div>Symmetry</div><div id="symVal">-</div></div>
      <div><div>Power</div><div id="powVal">-</div></div>
      <div><div>Consistency</div><div id="conVal">-</div></div>
    </div>
    <pre id="raw" class="muted"></pre>
  </div>

  <script>
    const $ = (q)=>document.querySelector(q);
    const keyEl = $('#apiKey'), payEl = $('#payload'), resCard = $('#result');
    const scoreBtn = $('#score'), genBtn = $('#gen'), expBtn = $('#explain');
    const scoreVal = $('#scoreVal'), symVal = $('#symVal'), powVal = $('#powVal'), conVal = $('#conVal'), meta = $('#meta'), raw = $('#raw');

    // init
    const saved = localStorage.getItem('picca_api_key');
    if (saved) keyEl.value = saved;
    // Dummy payload
    function genDummy(n=100){
      const pts=[]; for(let i=0;i<n;i++){ pts.push({x:+(0.5+0.1*(Math.random()*2-1)).toFixed(3), y:+(0.5+0.1*(Math.random()*2-1)).toFixed(3)}); }
      return JSON.stringify({fps:30, keypoints: pts}, null, 2);
    }
    payEl.value = genDummy(50);

    $('#saveKey').onclick = ()=> { localStorage.setItem('picca_api_key', keyEl.value); alert('Saved.'); };
    genBtn.onclick = ()=> { payEl.value = genDummy(100); };

    async function postJSON(path, body){
      const t0 = performance.now();
      const res = await fetch(path, {
        method:'POST',
        headers: {'Content-Type':'application/json', 'X-API-Key': keyEl.value},
        body: JSON.stringify(body)
      });
      const t1 = performance.now();
      const txt = await res.text();
      let json=null; try { json = JSON.parse(txt); } catch(e){}
      return {ok: res.ok, status: res.status, ms: Math.round(t1 - t0), json, txt};
    }

    scoreBtn.onclick = async ()=>{
      let body=null; try { body = JSON.parse(payEl.value); } catch(e){ alert('Invalid JSON'); return; }
      const r = await postJSON('/api/v1/score', body);
      resCard.style.display='block';
      meta.textContent = `status=${r.status}  ?  latency=${r.ms}ms`;
      raw.textContent = r.json ? JSON.stringify(r.json, null, 2) : r.txt;
      if (r.ok && r.json){
        scoreVal.textContent = r.json.score ?? '-';
        symVal.textContent   = r.json.symmetry ?? '-';
        powVal.textContent   = r.json.power ?? '-';
        conVal.textContent   = r.json.consistency ?? '-';
      } else {
        scoreVal.textContent = symVal.textContent = powVal.textContent = conVal.textContent = '?';
      }
    };

    // Enable Explain button only if endpoint exists
    fetch('/api/v1/explain', {method:'OPTIONS'}).then(()=>{ expBtn.disabled=false; }).catch(()=>{});
    expBtn.onclick = async ()=>{
      let body=null; try { body = JSON.parse(payEl.value); } catch(e){ alert('Invalid JSON'); return; }
      const rScore = await postJSON('/api/v1/score', body);
      if (!rScore.ok || !rScore.json){ alert('Score first failed.'); return; }
      const m = rScore.json;
      const r = await postJSON('/api/v1/explain', {score:m.score, symmetry:m.symmetry, power:m.power, consistency:m.consistency});
      alert(r.ok && r.json ? r.json.summary : ('Explain failed: '+r.status));
    };
  </script>
</body>
</html>